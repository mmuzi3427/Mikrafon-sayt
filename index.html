<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ovoz yozib oluvchi — Statik sahifa</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{max-width:900px;margin:28px auto;padding:18px}
    h1{font-size:1.3rem;margin-bottom:8px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    button{padding:10px 14px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button.record{background:#ffdddd}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .recordings{margin-top:16px}
    .rec-item{display:flex;gap:10px;align-items:center;padding:8px;border:1px solid #eee;border-radius:8px;margin-bottom:8px}
    .meta{font-size:0.85rem;color:#333}
    label{display:block;margin-top:12px}
    input[type=text]{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc}
    .hint{font-size:0.82rem;color:#666;margin-top:6px}
    @media (max-width:480px){.controls{flex-direction:column}}
  </style>
</head>
<body>
  <h1>Ovoz yozib oluvchi — statik sahifa</h1>
  <p class="hint">Brauzer ichida yozing, saqlang (brauzer xotirasi — IndexedDB), yoki Telegram-ga yuboring (token & chat_id kiritilishi kerak — serverda token saqlash tavsiya etiladi).</p>

  <div class="controls">
    <button id="startBtn">Yozishni boshlash</button>
    <button id="stopBtn" disabled>To'xtatish</button>
    <button id="saveLocalBtn" disabled>Brauzerga saqlash</button>
    <button id="clearAllBtn">Barchasini o'chirish</button>
  </div>

  <label>Fayl nomi (saqlash uchun): <input id="filenameInput" type="text" placeholder="misol: yozuv-2025-10-26" /></label>

  <hr />

  <h2>Telegram-ga yuborish</h2>
  <label>Bot token: <input id="botToken" type="text" placeholder="123456:ABC-DEF..." /></label>
  <label>Chat ID: <input id="chatId" type="text" placeholder="-1001234567890 yoki 123456789" /></label>
  <div class="hint">Eslatma: Clientda token ishlatish xavfsiz emas. Imkon bo'lsa, server orqali yuboring.</div>

  <div class="recordings" id="list"></div>

<script>
// Simple IndexedDB helper for storing blobs
const DB_NAME = 'voice-rec-db';
const STORE = 'recordings';
function openDB(){
  return new Promise((res, rej)=>{
    const r = indexedDB.open(DB_NAME, 1);
    r.onupgradeneeded = ()=>{
      r.result.createObjectStore(STORE, {keyPath:'id'});
    };
    r.onsuccess = ()=>res(r.result);
    r.onerror = ()=>rej(r.error);
  });
}
async function saveBlobToDB(id, name, blob){
  const db = await openDB();
  return new Promise((res, rej)=>{
    const tx = db.transaction(STORE, 'readwrite');
    tx.objectStore(STORE).put({id, name, blob, created: Date.now()});
    tx.oncomplete = ()=>res();
    tx.onerror = ()=>rej(tx.error);
  });
}
async function getAllFromDB(){
  const db = await openDB();
  return new Promise((res, rej)=>{
    const out=[];
    const tx = db.transaction(STORE,'readonly');
    const cur = tx.objectStore(STORE).openCursor();
    cur.onsuccess = e=>{
      const c = e.target.result;
      if(!c){res(out);return}
      out.push(c.value);
      c.continue();
    };
    cur.onerror = ()=>rej(cur.error);
  });
}
async function deleteFromDB(id){
  const db = await openDB();
  return new Promise((res, rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).delete(id);
    tx.oncomplete = ()=>res();
    tx.onerror = ()=>rej(tx.error);
  });
}
async function clearDB(){
  const db = await openDB();
  return new Promise((res, rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).clear();
    tx.oncomplete = ()=>res();
    tx.onerror = ()=>rej(tx.error);
  });
}

// MediaRecorder logic
let mediaRecorder, chunks = [];
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const saveLocalBtn = document.getElementById('saveLocalBtn');
const filenameInput = document.getElementById('filenameInput');
const list = document.getElementById('list');
const clearAllBtn = document.getElementById('clearAllBtn');

startBtn.addEventListener('click', async ()=>{
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    chunks = [];
    mediaRecorder.ondataavailable = e=>chunks.push(e.data);
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(chunks, {type:'audio/webm'});
      // create temporary preview entry (not saved until user clicks save)
      renderTemporary(blob);
      saveLocalBtn.disabled = false;
    };
    mediaRecorder.start();
    startBtn.disabled = true; stopBtn.disabled = false; startBtn.classList.add('record');
  }catch(err){alert('Mikrofonga ruxsat kerak: '+err.message)}
});

stopBtn.addEventListener('click', ()=>{
  if(mediaRecorder && mediaRecorder.state !== 'inactive'){
    mediaRecorder.stop();
    startBtn.disabled = false; stopBtn.disabled = true; startBtn.classList.remove('record');
  }
});

let lastTempBlob = null;
function renderTemporary(blob){
  lastTempBlob = blob;
  const id = 'temp-'+Date.now();
  const name = filenameInput.value.trim() || ('yozuv-'+(new Date()).toISOString());
  const node = document.createElement('div');
  node.className='rec-item';
  node.id = id;
  const url = URL.createObjectURL(blob);
  node.innerHTML = `
    <div style="flex:1">
      <div class="meta"><strong>${name}</strong> — <small>${new Date().toLocaleString()}</small></div>
      <audio controls src="${url}"></audio>
    </div>
    <div style="display:flex;flex-direction:column;gap:6px">
      <button class="save-temp">Brauzerga saqlash</button>
      <button class="send-temp">Telegram-ga yuborish</button>
      <a class="download-temp" href="${url}" download="${name}.webm">Yuklab olish</a>
    </div>
  `;
  // remove previous temp if any
  const prev = document.querySelector('.rec-item[data-temp]');
  if(prev) prev.remove();
  node.setAttribute('data-temp','1');
  list.prepend(node);

  node.querySelector('.save-temp').addEventListener('click', async ()=>{
    const rid = 'r-'+Date.now();
    const fname = filenameInput.value.trim() || ('yozuv-'+(new Date()).toISOString());
    await saveBlobToDB(rid, fname+'.webm', blob);
    node.remove(); lastTempBlob=null; saveLocalBtn.disabled=true; await refreshList();
    alert('Saqlangan');
  });
  node.querySelector('.send-temp').addEventListener('click', ()=>{
    sendToTelegram(blob);
  });
}

saveLocalBtn.addEventListener('click', async ()=>{
  if(!lastTempBlob){alert('Hech narsa yozilmadi');return}
  const rid = 'r-'+Date.now();
  const fname = filenameInput.value.trim() || ('yozuv-'+(new Date()).toISOString());
  await saveBlobToDB(rid, fname+'.webm', lastTempBlob);
  lastTempBlob = null; saveLocalBtn.disabled = true; const temp = document.querySelector('.rec-item[data-temp]'); if(temp) temp.remove();
  await refreshList();
  alert('Brauzerga saqlandi');
});

clearAllBtn.addEventListener('click', async ()=>{
  if(confirm('Haqiqatan ham barcha yozuvlarni o\'chirmoqchimisiz?')){
    await clearDB(); await refreshList(); alert('O\'chirildi');
  }
});

// render saved recordings
async function refreshList(){
  list.innerHTML = '';
  const items = await getAllFromDB();
  items.sort((a,b)=>b.created - a.created);
  for(const it of items){
    const url = URL.createObjectURL(it.blob);
    const node = document.createElement('div');
    node.className='rec-item';
    node.innerHTML = `
      <div style="flex:1">
        <div class="meta"><strong>${it.name}</strong> — <small>${new Date(it.created).toLocaleString()}</small></div>
        <audio controls src="${url}"></audio>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="send">Telegram-ga yuborish</button>
        <a class="download" href="${url}" download="${it.name}">Yuklab olish</a>
        <button class="del">O'chirish</button>
      </div>
    `;
    node.querySelector('.send').addEventListener('click', ()=>sendToTelegram(it.blob));
    node.querySelector('.del').addEventListener('click', async ()=>{ if(confirm('O\'chirmoqchimisiz?')){ await deleteFromDB(it.id); await refreshList(); }});
    list.appendChild(node);
  }
}

// Telegram upload (client-side). WARNING: exposing bot token in client is insecure.
async function sendToTelegram(blob){
  const token = document.getElementById('botToken').value.trim();
  const chatId = document.getElementById('chatId').value.trim();
  if(!token || !chatId){alert('Iltimos bot token va chat_id kiriting');return}
  try{
    const form = new FormData();
    // Telegram sendAudio expects an audio file or multipart/form-data with field 'audio' OR sendDocument. We'll use sendAudio.
    form.append('chat_id', chatId);
    // convert to file with name
    const file = new File([blob], 'voice.webm', {type: blob.type});
    form.append('audio', file);

    const resp = await fetch(`https://api.telegram.org/bot${token}/sendAudio`, {method:'POST', body:form});
    const j = await resp.json();
    if(j.ok) alert('Telegram-ga yuborildi'); else alert('Yuborishda xatolik: '+JSON.stringify(j));
  }catch(err){alert('Xatolik: '+err.message)}
}

// init
refreshList();
</script>
</body>
</html>
